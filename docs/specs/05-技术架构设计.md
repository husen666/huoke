# 技术架构详细设计

## 1. 总体架构

### 1.1 架构风格

采用 **模块化单体 (Modular Monolith)** 架构，兼顾开发效率与可扩展性：
- 初期：单体部署，按业务模块隔离
- 中期：按需拆分为微服务
- 优势：避免过早微服务化的复杂度，保持快速迭代

### 1.2 技术栈确认

```
┌─────────────────────────────────────────────────────────────┐
│                         前端层                               │
│  Next.js 15 (App Router) + React 19 + TypeScript 5.x       │
│  Tailwind CSS 4 + shadcn/ui + Radix UI                     │
│  Zustand (状态) + TanStack Query (数据) + Socket.IO Client  │
│  Recharts (图表) + ReactFlow (工作流) + TipTap (富文本)      │
├─────────────────────────────────────────────────────────────┤
│                         网关层                               │
│  Nginx (反向代理 + SSL + 静态资源)                           │
├─────────────────────────────────────────────────────────────┤
│                         服务层                               │
│  Hono (API框架) + Node.js 22 LTS + TypeScript               │
│  Drizzle ORM + Zod (校验) + Socket.IO Server                │
│  BullMQ (任务队列) + node-cron (定时任务)                    │
├─────────────────────────────────────────────────────────────┤
│                         AI 层                                │
│  LangChain.js + DeepSeek API (V3 + R1)                      │
│  Embedding: DeepSeek / BGE-M3 (本地可选)                     │
│  Qdrant (向量库) + Hybrid Search                             │
├─────────────────────────────────────────────────────────────┤
│                         数据层                               │
│  PostgreSQL 16 (主库) + Redis 7 (缓存/队列/会话)             │
│  Meilisearch (全文搜索) + MinIO (文件存储)                   │
├─────────────────────────────────────────────────────────────┤
│                         基础设施                              │
│  Docker + Docker Compose (部署)                              │
│  Prometheus + Grafana (监控) + Loki (日志)                   │
│  Caddy/Nginx (HTTPS) + Let's Encrypt                        │
└─────────────────────────────────────────────────────────────┘
```

---

## 2. 项目工程结构

### 2.1 Monorepo 结构 (Turborepo + pnpm)

```
huokeagent/
├── apps/
│   ├── web/                          # Next.js 前端
│   │   ├── app/
│   │   │   ├── (auth)/
│   │   │   │   ├── login/page.tsx
│   │   │   │   ├── register/page.tsx
│   │   │   │   └── layout.tsx
│   │   │   ├── (dashboard)/
│   │   │   │   ├── layout.tsx        # 侧边栏 + 顶栏布局
│   │   │   │   ├── page.tsx          # 总览仪表盘
│   │   │   │   ├── leads/
│   │   │   │   │   ├── page.tsx      # 线索列表
│   │   │   │   │   └── [id]/page.tsx # 线索详情
│   │   │   │   ├── customers/
│   │   │   │   │   ├── page.tsx      # 客户列表
│   │   │   │   │   └── [id]/page.tsx # 客户360°
│   │   │   │   ├── inbox/
│   │   │   │   │   └── page.tsx      # 统一收件箱
│   │   │   │   ├── knowledge/
│   │   │   │   │   └── page.tsx      # 知识库管理
│   │   │   │   ├── campaigns/
│   │   │   │   │   ├── page.tsx      # 营销活动
│   │   │   │   │   └── [id]/page.tsx
│   │   │   │   ├── workflows/
│   │   │   │   │   ├── page.tsx      # 工作流列表
│   │   │   │   │   └── [id]/page.tsx # 工作流编辑器
│   │   │   │   ├── analytics/
│   │   │   │   │   ├── page.tsx      # 数据分析
│   │   │   │   │   ├── channels/page.tsx
│   │   │   │   │   └── reports/page.tsx
│   │   │   │   └── settings/
│   │   │   │       ├── page.tsx
│   │   │   │       ├── team/page.tsx
│   │   │   │       ├── channels/page.tsx
│   │   │   │       └── integrations/page.tsx
│   │   │   ├── layout.tsx
│   │   │   └── globals.css
│   │   ├── components/
│   │   │   ├── ui/                   # shadcn/ui 组件
│   │   │   ├── layout/               # 布局组件
│   │   │   │   ├── sidebar.tsx
│   │   │   │   ├── header.tsx
│   │   │   │   └── breadcrumb.tsx
│   │   │   ├── leads/                # 线索相关组件
│   │   │   ├── customers/            # 客户相关组件
│   │   │   ├── inbox/                # 消息组件
│   │   │   │   ├── conversation-list.tsx
│   │   │   │   ├── message-panel.tsx
│   │   │   │   └── customer-sidebar.tsx
│   │   │   ├── knowledge/            # 知识库组件
│   │   │   ├── workflows/            # 工作流编辑器组件
│   │   │   │   ├── flow-canvas.tsx
│   │   │   │   ├── node-panel.tsx
│   │   │   │   └── nodes/            # 各类节点组件
│   │   │   └── analytics/            # 图表组件
│   │   ├── hooks/                    # 自定义 Hooks
│   │   ├── lib/                      # 工具函数
│   │   │   ├── api.ts               # API 客户端
│   │   │   ├── socket.ts            # WebSocket 客户端
│   │   │   └── utils.ts
│   │   ├── stores/                   # Zustand 状态
│   │   ├── types/                    # TypeScript 类型
│   │   ├── next.config.ts
│   │   ├── tailwind.config.ts
│   │   ├── tsconfig.json
│   │   └── package.json
│   │
│   └── server/                       # Hono 后端服务
│       ├── src/
│       │   ├── index.ts              # 服务入口
│       │   ├── app.ts                # Hono 应用实例
│       │   ├── config/               # 配置
│       │   │   ├── env.ts            # 环境变量
│       │   │   ├── database.ts       # 数据库配置
│       │   │   └── redis.ts          # Redis 配置
│       │   ├── routes/               # API 路由
│       │   │   ├── auth.routes.ts
│       │   │   ├── lead.routes.ts
│       │   │   ├── customer.routes.ts
│       │   │   ├── conversation.routes.ts
│       │   │   ├── knowledge.routes.ts
│       │   │   ├── campaign.routes.ts
│       │   │   ├── workflow.routes.ts
│       │   │   ├── analytics.routes.ts
│       │   │   ├── channel.routes.ts
│       │   │   └── webhook.routes.ts
│       │   ├── services/             # 业务逻辑层
│       │   │   ├── auth.service.ts
│       │   │   ├── lead.service.ts
│       │   │   ├── customer.service.ts
│       │   │   ├── conversation.service.ts
│       │   │   ├── knowledge.service.ts
│       │   │   ├── campaign.service.ts
│       │   │   ├── workflow.service.ts
│       │   │   ├── analytics.service.ts
│       │   │   └── notification.service.ts
│       │   ├── integrations/         # 第三方平台集成
│       │   │   ├── wechat/
│       │   │   │   ├── wechat-work.ts    # 企业微信 SDK
│       │   │   │   ├── wechat-mp.ts      # 公众号
│       │   │   │   └── wechat-types.ts
│       │   │   ├── dingtalk/
│       │   │   │   ├── dingtalk.ts       # 钉钉 SDK
│       │   │   │   └── dingtalk-types.ts
│       │   │   ├── douyin/
│       │   │   │   └── douyin.ts         # 抖音 SDK
│       │   │   ├── xiaohongshu/
│       │   │   │   └── xiaohongshu.ts    # 小红书 SDK
│       │   │   └── baidu/
│       │   │       └── baidu-sem.ts      # 百度 SEM
│       │   ├── ai/                   # AI 引擎
│       │   │   ├── llm/
│       │   │   │   ├── deepseek.ts       # DeepSeek 客户端
│       │   │   │   ├── prompts.ts        # Prompt 模板
│       │   │   │   └── chains.ts         # LangChain 链
│       │   │   ├── rag/
│       │   │   │   ├── embeddings.ts     # 向量化
│       │   │   │   ├── retriever.ts      # 检索器
│       │   │   │   ├── document-loader.ts # 文档加载
│       │   │   │   └── splitter.ts       # 文档切片
│       │   │   ├── memory/
│       │   │   │   ├── short-term.ts     # 短期记忆
│       │   │   │   ├── long-term.ts      # 长期记忆
│       │   │   │   └── shared.ts         # 共享记忆
│       │   │   └── agents/
│       │   │       ├── customer-agent.ts  # 客服 Agent
│       │   │       ├── scoring-agent.ts   # 评分 Agent
│       │   │       └── analytics-agent.ts # 分析 Agent
│       │   ├── workers/              # 后台任务 Worker
│       │   │   ├── lead-processor.ts     # 线索处理
│       │   │   ├── message-sender.ts     # 消息发送
│       │   │   ├── document-processor.ts # 文档处理
│       │   │   ├── workflow-executor.ts  # 工作流执行
│       │   │   ├── analytics-aggregator.ts # 数据聚合
│       │   │   └── scheduler.ts          # 定时任务调度
│       │   ├── websocket/            # WebSocket
│       │   │   ├── socket.ts             # Socket.IO 服务
│       │   │   └── handlers.ts           # 事件处理
│       │   ├── middleware/           # 中间件
│       │   │   ├── auth.ts               # JWT 认证
│       │   │   ├── rbac.ts               # 权限控制
│       │   │   ├── rate-limit.ts         # 限流
│       │   │   ├── logger.ts             # 日志
│       │   │   └── error-handler.ts      # 错误处理
│       │   ├── db/                   # 数据库
│       │   │   ├── schema/               # Drizzle Schema
│       │   │   │   ├── users.ts
│       │   │   │   ├── leads.ts
│       │   │   │   ├── customers.ts
│       │   │   │   ├── conversations.ts
│       │   │   │   ├── knowledge.ts
│       │   │   │   ├── campaigns.ts
│       │   │   │   ├── workflows.ts
│       │   │   │   └── index.ts
│       │   │   ├── migrations/           # 迁移文件
│       │   │   └── seed.ts               # 种子数据
│       │   └── utils/                # 工具
│       │       ├── crypto.ts             # 加密
│       │       ├── validators.ts         # 校验
│       │       └── helpers.ts            # 辅助函数
│       ├── drizzle.config.ts
│       ├── tsconfig.json
│       └── package.json
│
├── packages/
│   ├── shared/                       # 共享包
│   │   ├── src/
│   │   │   ├── types/               # 共享类型定义
│   │   │   │   ├── lead.ts
│   │   │   │   ├── customer.ts
│   │   │   │   ├── conversation.ts
│   │   │   │   └── index.ts
│   │   │   ├── constants/           # 共享常量
│   │   │   └── utils/               # 共享工具
│   │   ├── tsconfig.json
│   │   └── package.json
│   │
│   └── config/                       # 共享配置
│       ├── eslint/
│       ├── typescript/
│       └── prettier/
│
├── docker/
│   ├── Dockerfile.web               # 前端容器
│   ├── Dockerfile.server             # 后端容器
│   ├── nginx/
│   │   └── nginx.conf               # Nginx 配置
│   └── init/
│       └── init.sql                  # 数据库初始化
│
├── docker-compose.yml                # 完整部署配置
├── docker-compose.dev.yml            # 开发环境配置
├── turbo.json                        # Turborepo 配置
├── pnpm-workspace.yaml
├── package.json
├── .env.example                      # 环境变量模板
└── .gitignore
```

---

## 3. 核心技术方案

### 3.1 认证方案

```
JWT 双 Token 机制:

Access Token:
  - 有效期: 15 分钟
  - 存储: 内存 (前端)
  - 用途: API 请求认证

Refresh Token:
  - 有效期: 7 天
  - 存储: HttpOnly Cookie
  - 用途: 刷新 Access Token
  - 轮换: 每次使用后生成新 Token

登录流程:
  1. 用户提交账号密码
  2. 服务端验证 → 生成 Token Pair
  3. Access Token 返回 Body
  4. Refresh Token 设置 HttpOnly Cookie
  5. 前端内存存储 Access Token

刷新流程:
  1. Access Token 过期
  2. 前端自动调用 /auth/refresh
  3. 服务端验证 Refresh Token
  4. 返回新 Token Pair
  5. 旧 Refresh Token 失效（Token Rotation）
```

### 3.2 权限设计 (RBAC)

```
角色层级:
  超级管理员 → 管理员 → 主管 → 组长 → 客服/销售 → 只读

权限矩阵示例:
┌──────────┬──────┬──────┬──────┬──────┬──────┐
│ 资源      │ 创建 │ 读取 │ 更新 │ 删除 │ 导出 │
├──────────┼──────┼──────┼──────┼──────┼──────┤
│ 线索      │ ✓   │ ✓   │ ✓   │ ✗   │ ✓   │ ← 客服
│ 客户      │ ✓   │ 自己 │ 自己 │ ✗   │ ✗   │
│ 会话      │ -   │ 自己 │ 自己 │ ✗   │ ✗   │
│ 知识库    │ ✗   │ ✓   │ ✗   │ ✗   │ ✗   │
│ 营销活动  │ ✗   │ ✓   │ ✗   │ ✗   │ ✗   │
│ 数据分析  │ -   │ 自己 │ -   │ -   │ ✗   │
│ 系统设置  │ ✗   │ ✗   │ ✗   │ ✗   │ ✗   │
├──────────┼──────┼──────┼──────┼──────┼──────┤
│ 线索      │ ✓   │ ✓   │ ✓   │ ✓   │ ✓   │ ← 管理员
│ ...       │ ✓   │ ✓   │ ✓   │ ✓   │ ✓   │
└──────────┴──────┴──────┴──────┴──────┴──────┘

数据权限:
  - 自己的数据: 只能看/改自己负责的客户
  - 团队数据: 可以看团队成员的数据
  - 全部数据: 管理员可看所有数据
```

### 3.3 实时通信方案

```typescript
// Socket.IO 事件设计

// 客户端 → 服务端
interface ClientEvents {
  'message:send': (data: { conversationId: string; content: string; type: MessageType }) => void;
  'conversation:join': (conversationId: string) => void;
  'conversation:leave': (conversationId: string) => void;
  'agent:status': (status: 'online' | 'busy' | 'offline') => void;
  'typing:start': (conversationId: string) => void;
  'typing:stop': (conversationId: string) => void;
}

// 服务端 → 客户端
interface ServerEvents {
  'message:new': (message: Message) => void;
  'message:update': (message: Message) => void;
  'conversation:assigned': (conversation: Conversation) => void;
  'conversation:updated': (conversation: Conversation) => void;
  'lead:new': (lead: Lead) => void;
  'notification:new': (notification: Notification) => void;
  'typing:indicator': (data: { conversationId: string; userId: string }) => void;
  'agent:status_changed': (data: { agentId: string; status: string }) => void;
}
```

### 3.4 任务队列设计

```
BullMQ 队列:

┌─────────────────────────────────────────────┐
│ lead-processing (线索处理)                   │
│  - 线索清洗、去重、评分、分配                  │
│  - 并发: 10  重试: 3  超时: 30s              │
├─────────────────────────────────────────────┤
│ message-sending (消息发送)                    │
│  - 企微/钉钉/短信/邮件消息发送                 │
│  - 并发: 5   重试: 3  超时: 60s              │
│  - 限流: 各渠道独立限流                        │
├─────────────────────────────────────────────┤
│ document-processing (文档处理)                │
│  - 文档解析、切片、向量化                      │
│  - 并发: 3   重试: 2  超时: 300s             │
├─────────────────────────────────────────────┤
│ ai-tasks (AI 任务)                           │
│  - 意图识别、评分、摘要、分析                   │
│  - 并发: 5   重试: 2  超时: 120s             │
├─────────────────────────────────────────────┤
│ workflow-execution (工作流执行)                │
│  - 营销自动化工作流步骤执行                     │
│  - 并发: 10  重试: 3  超时: 60s              │
├─────────────────────────────────────────────┤
│ analytics-aggregation (数据聚合)              │
│  - 定时数据统计、报表生成                      │
│  - 并发: 2   重试: 1  超时: 600s             │
├─────────────────────────────────────────────┤
│ notification (通知推送)                       │
│  - 站内通知、企微/钉钉通知                     │
│  - 并发: 20  重试: 3  超时: 30s              │
└─────────────────────────────────────────────┘
```

---

## 4. DeepSeek 集成方案

### 4.1 模型调用封装

```typescript
// DeepSeek 客户端配置
const deepseekConfig = {
  baseURL: 'https://api.deepseek.com',
  apiKey: process.env.DEEPSEEK_API_KEY,
  
  models: {
    chat: 'deepseek-chat',         // DeepSeek-V3 通用对话
    reasoner: 'deepseek-reasoner', // DeepSeek-R1 深度推理
  },
  
  // 使用场景 → 模型映射
  useCases: {
    customerService: 'chat',       // 客服对话
    intentRecognition: 'chat',     // 意图识别
    leadScoring: 'reasoner',       // 线索评分(需要分析)
    contentGeneration: 'chat',     // 内容生成
    dataAnalysis: 'reasoner',      // 数据分析
    summarization: 'chat',         // 对话摘要
    memoryExtraction: 'chat',      // 记忆提取
  },
  
  // 降级策略
  fallback: {
    enabled: true,
    retries: 3,
    backoff: 'exponential',
    // 如 DeepSeek 不可用，可降级到本地模型或缓存回复
  }
};
```

### 4.2 Prompt 管理

```
Prompt 模板存储在数据库中，支持版本管理：

prompt_templates:
  - id: customer_service_v2
    name: "客服通用 Prompt"
    version: 2
    system_prompt: |
      你是{company_name}的AI客服助手{bot_name}。
      
      ## 你的角色
      - 专业、友善、有耐心的客服代表
      - 了解公司所有产品和服务
      
      ## 客户信息
      - 姓名: {customer_name}
      - 公司: {customer_company}
      - 历史记忆: {customer_memories}
      
      ## 知识库上下文
      {rag_context}
      
      ## 回复规范
      1. 回复简洁明了，不超过200字
      2. 遇到不确定的问题，坦诚告知并转人工
      3. 涉及价格，给出范围而非精确报价
      4. 适时引导客户留下联系方式
      5. 语气亲切专业，使用中文
      
    variables: [company_name, bot_name, customer_name, ...]
    active: true
```

### 4.3 成本控制

```
DeepSeek API 成本优化策略:

1. 分级调用:
   - 简单问候/FAQ → 本地规则匹配 (免费)
   - 普通对话 → DeepSeek-V3 (低成本)
   - 复杂分析 → DeepSeek-R1 (按需)

2. 缓存策略:
   - 相似问题缓存 (向量相似度>0.95 直接返回)
   - FAQ 精确匹配 (不调用 LLM)
   - 每日限额告警

3. Token 优化:
   - Prompt 压缩 (去除冗余上下文)
   - 回复长度限制
   - 历史对话窗口限制 (最近10轮)

4. 成本监控:
   - 实时 Token 消耗统计
   - 每日/每月成本看板
   - 超额告警
```

---

## 5. 自部署方案

### 5.1 Docker Compose 部署

```yaml
# docker-compose.yml 核心服务
services:
  nginx:           # 反向代理
  web:             # Next.js 前端 (端口 3000)
  server:          # Hono 后端 (端口 4000)
  postgres:        # PostgreSQL 16 (端口 5432)
  redis:           # Redis 7 (端口 6379)
  qdrant:          # Qdrant 向量库 (端口 6333)
  meilisearch:     # 全文搜索 (端口 7700)
  minio:           # 文件存储 (端口 9000)
```

### 5.2 最低配置要求

| 配置项 | 最低要求 | 推荐配置 |
|-------|---------|---------|
| CPU | 4 核 | 8 核+ |
| 内存 | 8 GB | 16 GB+ |
| 硬盘 | 50 GB SSD | 200 GB SSD |
| 带宽 | 5 Mbps | 20 Mbps+ |
| 系统 | Ubuntu 22.04 / CentOS 8 | Ubuntu 22.04 LTS |

### 5.3 一键部署脚本

```bash
# 一键部署命令
git clone https://github.com/your-org/huokeagent.git
cd huokeagent
cp .env.example .env
# 编辑 .env 配置 DeepSeek API Key 等
docker compose up -d
```

### 5.4 数据备份策略

```
自动备份:
  - PostgreSQL: 每日凌晨 3:00 全量备份 + WAL 持续归档
  - Redis: RDB 快照 (每小时) + AOF 持久化
  - Qdrant: 每日快照
  - MinIO: 数据目录定期备份
  - 备份保留: 7天滚动 + 每月一份长期保留

恢复:
  - RPO (恢复点目标): < 1小时
  - RTO (恢复时间目标): < 30分钟
```

---

## 6. 监控告警

### 6.1 监控指标

| 类别 | 指标 | 告警阈值 |
|------|------|---------|
| 系统 | CPU 使用率 | > 80% |
| 系统 | 内存使用率 | > 85% |
| 系统 | 磁盘使用率 | > 90% |
| 应用 | API 错误率 | > 1% |
| 应用 | API P95 延迟 | > 500ms |
| 应用 | WebSocket 连接数 | > 5000 |
| 数据库 | 连接池使用率 | > 80% |
| 数据库 | 慢查询数/分钟 | > 10 |
| Redis | 内存使用率 | > 80% |
| 队列 | 积压任务数 | > 1000 |
| AI | API 调用失败率 | > 5% |
| AI | 日 Token 消耗 | 超预算 80% |

### 6.2 告警渠道
- 钉钉机器人告警
- 企业微信告警
- 邮件告警
- 短信告警（严重级别）

---

## 7. 移动端预留设计

### 7.1 架构预留

- **响应式 Web**：Tailwind CSS 移动端断点设计
- **PWA**：Service Worker + 离线缓存 + 推送通知
- **API 设计**：RESTful API 同时支持 Web/小程序/APP
- **微信小程序**：后续使用 Taro/UniApp 复用逻辑层

### 7.2 移动端功能优先级

| 功能 | 移动端优先级 | 说明 |
|------|------------|------|
| 消息收件箱 | P0 | 随时随地回复客户 |
| 通知提醒 | P0 | 新线索/新消息推送 |
| 客户列表/详情 | P0 | 查看客户信息 |
| 线索管理 | P1 | 基础线索操作 |
| 数据看板 | P1 | 关键指标查看 |
| 工作流 | P2 | 仅查看状态 |
| 知识库 | P2 | 仅查询 |
| 系统设置 | P3 | PC 端操作 |
