# 数据库完整设计

## 1. 概述

- **主数据库**: PostgreSQL 16（关系数据 + JSON 扩展字段）
- **向量数据库**: Qdrant（文档向量 + 记忆向量）
- **缓存**: Redis 7（会话缓存 + 任务队列 + 实时数据）
- **全文搜索**: Meilisearch（客户/线索/知识全文检索）

---

## 2. PostgreSQL Schema 设计

### 2.1 组织与用户

```sql
-- 组织/租户
CREATE TABLE organizations (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  name VARCHAR(200) NOT NULL,
  logo_url TEXT,
  plan VARCHAR(50) DEFAULT 'free',  -- free/pro/enterprise
  settings JSONB DEFAULT '{}',
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- 用户
CREATE TABLE users (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  org_id UUID NOT NULL REFERENCES organizations(id),
  email VARCHAR(255) NOT NULL UNIQUE,
  phone VARCHAR(20),
  password_hash VARCHAR(255) NOT NULL,
  name VARCHAR(100) NOT NULL,
  avatar_url TEXT,
  role VARCHAR(50) NOT NULL DEFAULT 'agent',
    -- super_admin / admin / manager / team_lead / agent / sales / readonly
  status VARCHAR(20) DEFAULT 'active',  -- active / inactive / suspended
  last_login_at TIMESTAMPTZ,
  settings JSONB DEFAULT '{}',
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- 团队
CREATE TABLE teams (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  org_id UUID NOT NULL REFERENCES organizations(id),
  name VARCHAR(100) NOT NULL,
  description TEXT,
  leader_id UUID REFERENCES users(id),
  created_at TIMESTAMPTZ DEFAULT NOW()
);

-- 用户-团队关联
CREATE TABLE user_teams (
  user_id UUID REFERENCES users(id),
  team_id UUID REFERENCES teams(id),
  role VARCHAR(50) DEFAULT 'member',
  PRIMARY KEY (user_id, team_id)
);
```

### 2.2 渠道管理

```sql
-- 获客渠道
CREATE TABLE channels (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  org_id UUID NOT NULL REFERENCES organizations(id),
  platform VARCHAR(50) NOT NULL,
    -- wechat_work / wechat_mp / douyin / xiaohongshu
    -- baidu_sem / kuaishou / bilibili / zhihu / weibo / other
  name VARCHAR(200) NOT NULL,
  config JSONB NOT NULL DEFAULT '{}',
    -- 各平台 API Key、Token、配置等（加密存储）
  status VARCHAR(20) DEFAULT 'active',  -- active / paused / error
  webhook_url TEXT,
  webhook_secret VARCHAR(255),
  stats JSONB DEFAULT '{}',
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);
```

### 2.3 线索管理

```sql
-- 线索
CREATE TABLE leads (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  org_id UUID NOT NULL REFERENCES organizations(id),
  
  -- 来源信息
  channel_id UUID REFERENCES channels(id),
  source_platform VARCHAR(50),
  source_detail VARCHAR(500),    -- 具体来源描述
  campaign_id UUID,              -- 关联营销活动
  
  -- UTM 追踪
  utm_source VARCHAR(200),
  utm_medium VARCHAR(200),
  utm_campaign VARCHAR(200),
  utm_content VARCHAR(200),
  utm_term VARCHAR(200),
  
  -- 联系信息
  contact_name VARCHAR(200),
  contact_phone VARCHAR(20),
  contact_wechat VARCHAR(200),
  contact_email VARCHAR(255),
  contact_dingtalk VARCHAR(200),
  
  -- 公司信息
  company_name VARCHAR(500),
  company_industry VARCHAR(100),
  company_size VARCHAR(50),
  
  -- 地域
  province VARCHAR(50),
  city VARCHAR(50),
  district VARCHAR(50),
  
  -- 评分与状态
  score INTEGER DEFAULT 0,            -- 0-100
  score_details JSONB DEFAULT '{}',   -- 各维度评分
  ai_analysis JSONB DEFAULT '{}',     -- AI 分析结果
  status VARCHAR(30) DEFAULT 'new',
    -- new / contacted / qualified / converted / lost
  
  -- 分配
  assigned_to UUID REFERENCES users(id),
  assigned_at TIMESTAMPTZ,
  
  -- 原始数据
  raw_data JSONB DEFAULT '{}',
  
  -- 转化
  customer_id UUID,   -- 转化后关联的客户
  converted_at TIMESTAMPTZ,
  
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE INDEX idx_leads_org_status ON leads(org_id, status);
CREATE INDEX idx_leads_org_score ON leads(org_id, score DESC);
CREATE INDEX idx_leads_assigned ON leads(assigned_to) WHERE assigned_to IS NOT NULL;
CREATE INDEX idx_leads_phone ON leads(contact_phone) WHERE contact_phone IS NOT NULL;
CREATE INDEX idx_leads_created ON leads(org_id, created_at DESC);

-- 线索行为记录
CREATE TABLE lead_activities (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  lead_id UUID NOT NULL REFERENCES leads(id) ON DELETE CASCADE,
  type VARCHAR(50) NOT NULL,
    -- page_view / form_submit / chat_start / email_open
    -- link_click / download / event_attend / call
  description TEXT,
  metadata JSONB DEFAULT '{}',
  score_impact INTEGER DEFAULT 0,   -- 对评分的影响
  created_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE INDEX idx_lead_activities_lead ON lead_activities(lead_id, created_at DESC);
```

### 2.4 客户管理

```sql
-- 客户
CREATE TABLE customers (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  org_id UUID NOT NULL REFERENCES organizations(id),
  
  -- 基本信息
  type VARCHAR(20) DEFAULT 'individual',  -- individual / enterprise
  name VARCHAR(200) NOT NULL,
  avatar_url TEXT,
  
  -- 联系方式
  phone VARCHAR(20),
  wechat_id VARCHAR(200),
  dingtalk_id VARCHAR(200),
  email VARCHAR(255),
  
  -- 企业信息 (type=enterprise 时使用)
  company_name VARCHAR(500),
  company_credit_code VARCHAR(50),   -- 统一社会信用代码
  company_industry VARCHAR(100),
  company_size VARCHAR(50),
  company_website TEXT,
  company_address TEXT,
  
  -- 个人信息
  gender VARCHAR(10),                -- male / female / unknown
  age_range VARCHAR(20),
  region_province VARCHAR(50),
  region_city VARCHAR(50),
  
  -- 生命周期
  stage VARCHAR(30) DEFAULT 'potential',
    -- potential / interested / opportunity / closed / repeat / lost
  stage_changed_at TIMESTAMPTZ,
  
  -- 评分
  score INTEGER DEFAULT 0,
  score_details JSONB DEFAULT '{}',
  
  -- 分配
  owner_id UUID REFERENCES users(id),
  
  -- 自定义字段
  custom_fields JSONB DEFAULT '{}',
  
  -- 统计（异步更新）
  stats JSONB DEFAULT '{
    "total_deals": 0,
    "total_revenue": 0,
    "conversation_count": 0,
    "last_interaction_at": null
  }',
  
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE INDEX idx_customers_org_stage ON customers(org_id, stage);
CREATE INDEX idx_customers_org_score ON customers(org_id, score DESC);
CREATE INDEX idx_customers_owner ON customers(owner_id);
CREATE INDEX idx_customers_phone ON customers(phone) WHERE phone IS NOT NULL;
CREATE INDEX idx_customers_wechat ON customers(wechat_id) WHERE wechat_id IS NOT NULL;

-- 客户标签
CREATE TABLE tags (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  org_id UUID NOT NULL REFERENCES organizations(id),
  name VARCHAR(100) NOT NULL,
  color VARCHAR(20) DEFAULT '#808080',
  category VARCHAR(50),  -- source / behavior / value / stage / need / custom
  created_at TIMESTAMPTZ DEFAULT NOW(),
  UNIQUE(org_id, name)
);

-- 客户-标签关联
CREATE TABLE customer_tags (
  customer_id UUID REFERENCES customers(id) ON DELETE CASCADE,
  tag_id UUID REFERENCES tags(id) ON DELETE CASCADE,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  PRIMARY KEY (customer_id, tag_id)
);

CREATE INDEX idx_customer_tags_tag ON customer_tags(tag_id);

-- 客户联系人 (企业客户可有多个联系人)
CREATE TABLE customer_contacts (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  customer_id UUID NOT NULL REFERENCES customers(id) ON DELETE CASCADE,
  name VARCHAR(200) NOT NULL,
  title VARCHAR(100),        -- 职位
  role VARCHAR(50),          -- decision_maker / influencer / user / other
  phone VARCHAR(20),
  wechat_id VARCHAR(200),
  email VARCHAR(255),
  is_primary BOOLEAN DEFAULT false,
  created_at TIMESTAMPTZ DEFAULT NOW()
);

-- 客户活动时间线
CREATE TABLE customer_activities (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  customer_id UUID NOT NULL REFERENCES customers(id) ON DELETE CASCADE,
  user_id UUID REFERENCES users(id),  -- 操作人
  type VARCHAR(50) NOT NULL,
    -- stage_change / tag_change / note_added / deal_created
    -- conversation_started / email_sent / call_made / meeting
    -- score_change / owner_change / custom
  title VARCHAR(500),
  description TEXT,
  metadata JSONB DEFAULT '{}',
  created_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE INDEX idx_customer_activities_customer ON customer_activities(customer_id, created_at DESC);
```

### 2.5 会话与消息

```sql
-- 会话
CREATE TABLE conversations (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  org_id UUID NOT NULL REFERENCES organizations(id),
  customer_id UUID REFERENCES customers(id),
  
  -- 渠道信息
  channel_id UUID REFERENCES channels(id),
  channel_type VARCHAR(50),        -- wechat_work / dingtalk / douyin / web / etc
  external_chat_id VARCHAR(500),   -- 外部平台会话ID
  
  -- 分配
  agent_id UUID REFERENCES users(id),
  
  -- 状态
  status VARCHAR(30) DEFAULT 'pending',
    -- pending / active / resolved / closed
  priority VARCHAR(20) DEFAULT 'medium',
    -- low / medium / high / urgent
  
  -- AI
  ai_enabled BOOLEAN DEFAULT true,
  ai_summary TEXT,
  ai_sentiment VARCHAR(20),       -- positive / neutral / negative
  
  -- SLA
  sla_first_response_at TIMESTAMPTZ,
  sla_resolve_deadline TIMESTAMPTZ,
  
  -- 标签
  tags TEXT[] DEFAULT '{}',
  
  -- 满意度
  satisfaction_score INTEGER,      -- 1-5
  satisfaction_comment TEXT,
  
  -- 消息统计
  message_count INTEGER DEFAULT 0,
  last_message_at TIMESTAMPTZ,
  last_message_preview TEXT,
  
  first_response_at TIMESTAMPTZ,
  resolved_at TIMESTAMPTZ,
  closed_at TIMESTAMPTZ,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE INDEX idx_conversations_org_status ON conversations(org_id, status);
CREATE INDEX idx_conversations_agent ON conversations(agent_id, status);
CREATE INDEX idx_conversations_customer ON conversations(customer_id, created_at DESC);

-- 消息
CREATE TABLE messages (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  conversation_id UUID NOT NULL REFERENCES conversations(id) ON DELETE CASCADE,
  
  -- 发送者
  sender_type VARCHAR(20) NOT NULL,  -- customer / agent / ai / system
  sender_id VARCHAR(200),            -- user_id 或 external_user_id
  
  -- 内容
  content_type VARCHAR(30) DEFAULT 'text',
    -- text / image / voice / video / file / card / location / system
  content TEXT,
  media_url TEXT,
  metadata JSONB DEFAULT '{}',
  
  -- AI 相关
  ai_generated BOOLEAN DEFAULT false,
  ai_confidence FLOAT,
  ai_sources JSONB,                  -- RAG 检索来源
  
  -- 状态
  status VARCHAR(20) DEFAULT 'sent',
    -- sent / delivered / read / failed
  
  -- 外部平台消息ID (用于去重)
  external_message_id VARCHAR(500),
  
  created_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE INDEX idx_messages_conversation ON messages(conversation_id, created_at);
CREATE INDEX idx_messages_external ON messages(external_message_id)
  WHERE external_message_id IS NOT NULL;
```

### 2.6 商机管理

```sql
-- 商机
CREATE TABLE deals (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  org_id UUID NOT NULL REFERENCES organizations(id),
  customer_id UUID NOT NULL REFERENCES customers(id),
  
  title VARCHAR(500) NOT NULL,
  amount DECIMAL(15,2),              -- 预估金额
  currency VARCHAR(10) DEFAULT 'CNY',
  
  stage VARCHAR(50) DEFAULT 'initial',
    -- initial / needs_confirmed / proposal / negotiation / won / lost
  probability INTEGER DEFAULT 20,    -- 赢率 0-100
  
  expected_close_date DATE,
  actual_close_date DATE,
  
  owner_id UUID REFERENCES users(id),
  
  -- 产品
  products JSONB DEFAULT '[]',
  
  -- 竞品
  competitors JSONB DEFAULT '[]',
  
  -- 丢单原因
  loss_reason VARCHAR(500),
  
  notes TEXT,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE INDEX idx_deals_org_stage ON deals(org_id, stage);
CREATE INDEX idx_deals_customer ON deals(customer_id);
CREATE INDEX idx_deals_owner ON deals(owner_id);
```

### 2.7 知识库

```sql
-- 知识库
CREATE TABLE knowledge_bases (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  org_id UUID NOT NULL REFERENCES organizations(id),
  name VARCHAR(200) NOT NULL,
  description TEXT,
  settings JSONB DEFAULT '{}',
  document_count INTEGER DEFAULT 0,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- 知识库文档
CREATE TABLE documents (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  kb_id UUID NOT NULL REFERENCES knowledge_bases(id) ON DELETE CASCADE,
  
  title VARCHAR(500) NOT NULL,
  content TEXT,                  -- 解析后的纯文本
  file_url TEXT,                 -- 原始文件URL
  file_type VARCHAR(50),         -- pdf / docx / xlsx / md / url
  file_size INTEGER,
  
  category VARCHAR(200),
  tags TEXT[] DEFAULT '{}',
  
  -- 处理状态
  processing_status VARCHAR(30) DEFAULT 'pending',
    -- pending / processing / completed / failed
  chunk_count INTEGER DEFAULT 0,
  error_message TEXT,
  
  -- 版本
  version INTEGER DEFAULT 1,
  
  created_by UUID REFERENCES users(id),
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- 文档切片
CREATE TABLE document_chunks (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  document_id UUID NOT NULL REFERENCES documents(id) ON DELETE CASCADE,
  
  content TEXT NOT NULL,
  chunk_index INTEGER NOT NULL,
  token_count INTEGER,
  
  -- Qdrant 中的向量 ID (同步标识)
  vector_id VARCHAR(200),
  
  metadata JSONB DEFAULT '{}',
  created_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE INDEX idx_document_chunks_doc ON document_chunks(document_id, chunk_index);

-- FAQ
CREATE TABLE faqs (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  kb_id UUID NOT NULL REFERENCES knowledge_bases(id) ON DELETE CASCADE,
  
  question TEXT NOT NULL,
  answer TEXT NOT NULL,
  category VARCHAR(200),
  
  -- 使用统计
  use_count INTEGER DEFAULT 0,
  helpful_count INTEGER DEFAULT 0,
  
  vector_id VARCHAR(200),
  
  is_active BOOLEAN DEFAULT true,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);
```

### 2.8 AI 记忆

```sql
-- AI 记忆
CREATE TABLE memories (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  org_id UUID NOT NULL REFERENCES organizations(id),
  customer_id UUID REFERENCES customers(id),
  
  type VARCHAR(20) NOT NULL,  -- short_term / long_term / shared
  
  content TEXT NOT NULL,
  summary VARCHAR(1000),
  
  -- Qdrant 向量ID
  vector_id VARCHAR(200),
  
  -- 重要度与衰减
  importance FLOAT DEFAULT 0.5,      -- 0-1
  decay_factor FLOAT DEFAULT 0.95,   -- 衰减系数
  
  -- 来源
  source_type VARCHAR(50),           -- conversation / manual / ai_analysis
  source_id UUID,
  
  -- 分类
  category VARCHAR(100),             -- preference / need / event / personal / insight
  tags TEXT[] DEFAULT '{}',
  
  last_accessed_at TIMESTAMPTZ DEFAULT NOW(),
  created_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE INDEX idx_memories_customer ON memories(customer_id, type)
  WHERE customer_id IS NOT NULL;
CREATE INDEX idx_memories_org_shared ON memories(org_id, type)
  WHERE type = 'shared';
```

### 2.9 营销活动与工作流

```sql
-- 营销活动
CREATE TABLE campaigns (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  org_id UUID NOT NULL REFERENCES organizations(id),
  
  name VARCHAR(500) NOT NULL,
  description TEXT,
  type VARCHAR(50),        -- one_time / recurring / trigger_based
  
  -- 目标受众
  target_segment JSONB,    -- 分群条件
  target_count INTEGER,
  
  -- 内容
  content_template JSONB,
  channel_type VARCHAR(50),  -- wechat_work / dingtalk / sms / email
  
  -- A/B 测试
  ab_test_enabled BOOLEAN DEFAULT false,
  ab_variants JSONB DEFAULT '[]',
  
  -- 排期
  scheduled_at TIMESTAMPTZ,
  started_at TIMESTAMPTZ,
  completed_at TIMESTAMPTZ,
  
  -- 状态
  status VARCHAR(30) DEFAULT 'draft',
    -- draft / scheduled / running / paused / completed / cancelled
  
  -- 统计
  stats JSONB DEFAULT '{
    "sent": 0,
    "delivered": 0,
    "opened": 0,
    "clicked": 0,
    "replied": 0,
    "converted": 0
  }',
  
  created_by UUID REFERENCES users(id),
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- 营销活动执行记录
CREATE TABLE campaign_executions (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  campaign_id UUID NOT NULL REFERENCES campaigns(id),
  customer_id UUID REFERENCES customers(id),
  
  variant VARCHAR(10),     -- A/B 测试变体标识
  channel_type VARCHAR(50),
  
  -- 执行状态
  status VARCHAR(30) DEFAULT 'pending',
    -- pending / sent / delivered / opened / clicked / replied / failed
  
  sent_at TIMESTAMPTZ,
  delivered_at TIMESTAMPTZ,
  opened_at TIMESTAMPTZ,
  clicked_at TIMESTAMPTZ,
  replied_at TIMESTAMPTZ,
  
  error_message TEXT,
  metadata JSONB DEFAULT '{}',
  
  created_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE INDEX idx_campaign_exec_campaign ON campaign_executions(campaign_id, status);
CREATE INDEX idx_campaign_exec_customer ON campaign_executions(customer_id);

-- 工作流定义
CREATE TABLE workflows (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  org_id UUID NOT NULL REFERENCES organizations(id),
  
  name VARCHAR(500) NOT NULL,
  description TEXT,
  
  -- 工作流 JSON 定义 (节点 + 连线)
  definition JSONB NOT NULL DEFAULT '{"nodes":[],"edges":[]}',
  
  -- 触发配置
  trigger_type VARCHAR(50),   -- new_lead / tag_change / stage_change / schedule / webhook / manual
  trigger_config JSONB DEFAULT '{}',
  
  -- 状态
  is_active BOOLEAN DEFAULT false,
  
  -- 统计
  execution_count INTEGER DEFAULT 0,
  last_executed_at TIMESTAMPTZ,
  
  created_by UUID REFERENCES users(id),
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- 工作流执行实例
CREATE TABLE workflow_executions (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  workflow_id UUID NOT NULL REFERENCES workflows(id),
  
  -- 触发的目标
  target_type VARCHAR(50),   -- lead / customer
  target_id UUID,
  
  -- 执行状态
  status VARCHAR(30) DEFAULT 'running',
    -- running / waiting / completed / failed / cancelled
  current_node_id VARCHAR(200),
  
  -- 执行日志
  execution_log JSONB DEFAULT '[]',
  
  -- 等待信息 (如等待条件/延时)
  wait_until TIMESTAMPTZ,
  wait_condition JSONB,
  
  started_at TIMESTAMPTZ DEFAULT NOW(),
  completed_at TIMESTAMPTZ,
  error_message TEXT
);

CREATE INDEX idx_workflow_exec_workflow ON workflow_executions(workflow_id, status);
CREATE INDEX idx_workflow_exec_waiting ON workflow_executions(status, wait_until)
  WHERE status = 'waiting';
```

### 2.10 系统与审计

```sql
-- 操作日志
CREATE TABLE audit_logs (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  org_id UUID NOT NULL,
  user_id UUID,
  
  action VARCHAR(100) NOT NULL,    -- create / update / delete / login / export / etc
  resource_type VARCHAR(50),       -- lead / customer / conversation / etc
  resource_id UUID,
  
  changes JSONB,                   -- 变更前后对比
  ip_address INET,
  user_agent TEXT,
  
  created_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE INDEX idx_audit_logs_org ON audit_logs(org_id, created_at DESC);
CREATE INDEX idx_audit_logs_user ON audit_logs(user_id, created_at DESC);

-- 通知
CREATE TABLE notifications (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  org_id UUID NOT NULL,
  user_id UUID NOT NULL REFERENCES users(id),
  
  type VARCHAR(50) NOT NULL,
  title VARCHAR(500) NOT NULL,
  content TEXT,
  
  -- 关联资源
  resource_type VARCHAR(50),
  resource_id UUID,
  
  is_read BOOLEAN DEFAULT false,
  read_at TIMESTAMPTZ,
  
  created_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE INDEX idx_notifications_user ON notifications(user_id, is_read, created_at DESC);

-- 系统配置
CREATE TABLE system_configs (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  org_id UUID NOT NULL REFERENCES organizations(id),
  key VARCHAR(200) NOT NULL,
  value JSONB NOT NULL,
  updated_by UUID REFERENCES users(id),
  updated_at TIMESTAMPTZ DEFAULT NOW(),
  UNIQUE(org_id, key)
);
```

---

## 3. Qdrant 向量集合设计

```
Collections:

1. document_chunks_{org_id}
   - vectors: 1536 维 (DeepSeek Embedding)
   - payload: { doc_id, chunk_id, content, category, kb_id }

2. faqs_{org_id}
   - vectors: 1536 维
   - payload: { faq_id, question, answer, category, kb_id }

3. memories_{org_id}
   - vectors: 1536 维
   - payload: { memory_id, customer_id, type, content, importance, category }
```

---

## 4. Redis 数据结构

```
Key 设计:

Session:
  session:{user_id}            → JWT Token 信息 (STRING, TTL 15min)
  refresh:{token_hash}         → User ID (STRING, TTL 7d)

实时状态:
  agent:status:{user_id}       → online/busy/offline (STRING)
  agent:conversations:{user_id} → 当前会话ID集合 (SET)
  conversation:typing:{conv_id} → 正在输入的用户 (SET, TTL 5s)

缓存:
  customer:{id}                → 客户基础信息 (HASH, TTL 1h)
  lead:score:{id}              → 线索评分缓存 (STRING, TTL 5min)
  ai:response:{hash}           → AI 回复缓存 (STRING, TTL 24h)
  channel:config:{id}          → 渠道配置缓存 (HASH, TTL 30min)

统计:
  stats:daily:{org_id}:{date}  → 日统计数据 (HASH)
  stats:channel:{channel_id}:{date} → 渠道日统计 (HASH)

限流:
  ratelimit:{ip}:{endpoint}    → 请求计数 (STRING, TTL 1min)
  ratelimit:api:{api_key}      → API 调用计数 (STRING, TTL 1min)
  ratelimit:ai:{org_id}        → AI Token 消耗 (STRING, TTL 1d)
```

---

## 5. Meilisearch 索引设计

```
索引:

1. leads_{org_id}
   - 可搜索字段: contact_name, contact_phone, company_name, source_detail
   - 可筛选字段: status, score, source_platform, assigned_to, created_at
   - 可排序字段: score, created_at

2. customers_{org_id}
   - 可搜索字段: name, phone, wechat_id, email, company_name
   - 可筛选字段: type, stage, score, owner_id, tags
   - 可排序字段: score, created_at, stats.last_interaction_at

3. knowledge_{org_id}
   - 可搜索字段: title, content, category, tags
   - 可筛选字段: kb_id, file_type, processing_status
```
