# 火客系统部署指南（腾讯云 / Docker / 子路径）

本文档基于当前仓库配置整理，目标部署地址为：

- `https://www.aineoo.com/huoke/`

> 说明：主站 `www.aineoo.com` 由宿主机 Nginx 提供 HTTPS，火客系统通过 Docker 启动并反向代理到 `/huoke/` 子路径。

---

## 1. 前置条件

- 服务器已安装并可用：
  - Docker
  - Docker Compose
  - Nginx（宿主机）
- 域名 `www.aineoo.com` 已配置 SSL
- 服务器磁盘空间建议 >= 10GB 可用

建议先检查：

```bash
docker --version
docker compose version
nginx -v
df -h
```

---

## 2. 获取代码

```bash
cd /opt
git clone <your-repo-url> huoke
cd /opt/huoke
```

已存在仓库时：

```bash
cd /opt/huoke
git pull
```

---

## 3. 生产环境变量

仓库已支持通过 `ENV_FILE` 切换环境文件，推荐使用：

- `.env.prod`

核心配置示例（实际以服务器上的 `.env.prod` 为准）：

```env
NODE_ENV=production
NEXT_OUTPUT=standalone

APP_URL=https://www.aineoo.com/huoke
API_URL=http://server:4000

NEXT_BASE_PATH=/huoke
NEXT_PUBLIC_BASE_PATH=/huoke
NEXT_PUBLIC_API_URL=/huoke/api/v1

DATABASE_URL=postgresql://huoke:huoke123@postgres:5432/huokeagent
REDIS_URL=redis://redis:6379
QDRANT_URL=http://qdrant:6333
MEILISEARCH_URL=http://meilisearch:7700
MINIO_ENDPOINT=minio
MINIO_PORT=9000
MINIO_USE_SSL=false
```

---

## 4. Docker Compose 启动方式

当前仓库中：

- `web`、`server` 支持 `env_file: ${ENV_FILE:-.env}`
- `web` build args 已支持 `NEXT_OUTPUT` / `NEXT_BASE_PATH` / `NEXT_PUBLIC_BASE_PATH`
- 容器内 Nginx 监听并映射到宿主机：`127.0.0.1:18080:80`

启动命令：

```bash
cd /opt/huoke
ENV_FILE=.env.prod docker compose --env-file .env.prod down
ENV_FILE=.env.prod docker compose --env-file .env.prod up -d --build
ENV_FILE=.env.prod docker compose --env-file .env.prod ps
```

---

## 5. 数据库初始化（首次部署必做）

```bash
cd /opt/huoke
ENV_FILE=.env.prod docker compose --env-file .env.prod exec server pnpm db:migrate
ENV_FILE=.env.prod docker compose --env-file .env.prod exec server pnpm db:seed
```

默认种子账号：

- `admin@huoke.com`
- `admin123`

---

## 6. 宿主机 Nginx 配置（HTTPS + 子路径）

在 `www.aineoo.com` 的 `443` server 块中增加：

```nginx
location = /huoke {
    return 301 /huoke/;
}

location /huoke/ {
    proxy_pass http://127.0.0.1:18080;
    proxy_http_version 1.1;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection "upgrade";
    proxy_read_timeout 86400;
}
```

验证并重载：

```bash
sudo nginx -t
sudo systemctl reload nginx
```

---

## 7. 部署后验证

```bash
# 容器入口
curl -I http://127.0.0.1:18080/

# 线上访问
curl -I https://www.aineoo.com/huoke/
curl https://www.aineoo.com/huoke/api/v1/health
```

`/health` 预期返回：

- `ok: true`
- `checks.database.ok: true`

---

## 8. 常见问题排查

### 8.1 Docker 拉镜像超时（Docker Hub 网络问题）

可配置镜像加速：

`/etc/docker/daemon.json`

```json
{
  "registry-mirrors": [
    "https://docker.1ms.run",
    "https://mirror.ccs.tencentyun.com"
  ]
}
```

然后重启 Docker：

```bash
sudo systemctl daemon-reload
sudo systemctl restart docker
docker info | grep -A3 "Registry Mirrors"
```

### 8.2 `no space left on device`

说明磁盘不足（常见于构建阶段）。先清理：

```bash
docker builder prune -af
docker system prune -af
sudo journalctl --vacuum-time=3d
sudo apt-get clean
```

若云盘已扩容但系统仍显示旧容量，需要扩分区与文件系统（示例：`/dev/vda2`）：

```bash
sudo apt update
sudo apt install -y cloud-guest-utils
sudo growpart /dev/vda 2
sudo resize2fs /dev/vda2
df -h
```

### 8.3 `failed to bind host port 0.0.0.0:80`

宿主机 80 端口已被 Nginx 占用。使用 `127.0.0.1:18080:80` 映射可避免冲突（仓库已调整）。

### 8.4 `COPY failed: ... .next/standalone: file does not exist`

原因是构建阶段未拿到 `NEXT_OUTPUT=standalone`。仓库已支持从 `.env.prod` 传入 `NEXT_OUTPUT` build arg。

### 8.5 `curl 127.0.0.1:18080` 返回 `Connection reset by peer`

通常是容器异常退出，检查：

```bash
ENV_FILE=.env.prod docker compose --env-file .env.prod ps
ENV_FILE=.env.prod docker compose --env-file .env.prod logs nginx --tail=200
ENV_FILE=.env.prod docker compose --env-file .env.prod logs web --tail=120
ENV_FILE=.env.prod docker compose --env-file .env.prod logs server --tail=120
```

---

## 9. 常用运维命令

```bash
# 查看状态
ENV_FILE=.env.prod docker compose --env-file .env.prod ps

# 查看日志
ENV_FILE=.env.prod docker compose --env-file .env.prod logs -f nginx web server

# 重启单服务
ENV_FILE=.env.prod docker compose --env-file .env.prod restart web

# 停止服务
ENV_FILE=.env.prod docker compose --env-file .env.prod down
```

